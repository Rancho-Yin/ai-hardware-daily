name: AI Hardware Daily (Semi-auto) to Feishu

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 07:30ï¼ˆUTC 23:30ï¼‰
    - cron: "30 23 * * *"
  workflow_dispatch:

jobs:
  send-daily:
    runs-on: ubuntu-latest
    permissions:
      contents: write


    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Build daily digest (RSS + keywords)
        run: |
          python scripts/rss_digest.py > daily.txt
          echo "Generated daily.txt:"
          cat daily.txt

      - name: Post-process daily text (no Python code changes)
        run: |
          python - <<'PY'
          import re

          raw = open("daily.txt","r",encoding="utf-8").read().splitlines()

          # 1) åŠ ä¸€å¥è¯æ€»è§ˆï¼ˆå›ºå®šæ¨¡æ¿ï¼Œå…ˆä¸é AIï¼‰
          overview = [
            "ã€ä¸€å¥è¯æ€»è§ˆã€‘",
            "AIç¡¬ä»¶è¿›å…¥äº§å“åŒ–é˜¶æ®µï¼šæ›´çœ‹é‡èƒ½æ•ˆã€ä¾›åº”é“¾ä¸è½åœ°åœºæ™¯ã€‚",
            ""
          ]

          # 2) ç»™æ¯æ¡æ–°é—»åŠ â€œè½»æ ‡ç­¾â€ï¼ˆä»…åŸºäºæ ‡é¢˜å…³é”®è¯ï¼‰
          def tag(title: str):
            t = (title or "").lower()
            if any(k in t for k in ["gpu","npu","hbm","chip","semiconductor","tsmc","èŠ¯ç‰‡","ç®—åŠ›","æ˜‡è…¾","å¯’æ­¦çºª","æ‘©å°”çº¿ç¨‹","æµ·å…‰"]):
              return "ã€èŠ¯ç‰‡/ç®—åŠ›ã€‘"
            if any(k in t for k in ["server","datacenter","æ•°æ®ä¸­å¿ƒ","æ¶²å†·","cooling","800g","å…‰æ¨¡å—","äº¤æ¢","ç½‘ç»œ","cxl","pcie"]):
              return "ã€æ•°æ®ä¸­å¿ƒã€‘"
            if any(k in t for k in ["robot","humanoid","æœºå™¨äºº","å…·èº«","äººå½¢"]):
              return "ã€æœºå™¨äººã€‘"
            if any(k in t for k in ["ç«¯ä¾§","edge","ç»ˆç«¯","æ‰‹æœº","pc","laptop"]):
              return "ã€ç»ˆç«¯/è¾¹ç¼˜ã€‘"
            return "ã€å…¶ä»–ã€‘"

          out = []
          out.extend(overview)

          section = None
          count_in_section = 0
          for line in raw:
            # ä¿ç•™åŸå¤´éƒ¨æ—¥æœŸè¡Œ
            if line.startswith("ğŸ¤– "):
              out.append(line)
              continue

            # è¯†åˆ«åˆ†æ®µ
            if line.strip() in ["ğŸŒ å…¨çƒ", "ğŸ‡¨ğŸ‡³ ä¸­å›½"]:
              section = line.strip()
              count_in_section = 0
              out.append("")
              out.append(section)
              continue

            # ç©ºè¡Œç…§æŠ„
            if not line.strip():
              continue

            # æ–°é—»æ ‡é¢˜è¡Œï¼ˆå½¢å¦‚ "1. xxx"ï¼‰
            m = re.match(r"^\d+\.\s+(.*)$", line.strip())
            if m and section:
              # æ¯æ®µæœ€å¤š 6 æ¡ï¼ˆç²¾ç®€ï¼‰
              if count_in_section >= 6:
                continue
              title = m.group(1)
              out.append(re.sub(r"^\d+\.\s+", f"{count_in_section+1}. {tag(title)} ", line.strip()))
              count_in_section += 1
              continue

            # é“¾æ¥è¡Œï¼šç´§è·Ÿæ ‡é¢˜è¾“å‡º
            if section and line.startswith("http"):
              # åªæœ‰åœ¨æ²¡è¢«æˆªæ–­çš„æƒ…å†µä¸‹æ‰ä¿ç•™é“¾æ¥
              # ï¼ˆå¦‚æœä¸Šä¸€æ¡æ ‡é¢˜è¢«æˆªæ–­ï¼Œé“¾æ¥ä¹Ÿä¼šè¢«è·³è¿‡ï¼Œå› ä¸ºä¸ä¼šèµ°åˆ°è¿™é‡Œï¼‰
              out.append(line.strip())
              continue

          # 3) å°¾éƒ¨è¯´æ˜
          out.append("")
          out.append("ğŸ“Œ è¯´æ˜ï¼šæœ¬æ—¥æŠ¥ä¸º RSS+å…³é”®è¯ç­›é€‰ï¼ˆåŠè‡ªåŠ¨ï¼‰ã€‚")

          open("daily_final.txt","w",encoding="utf-8").write("\n".join(out).strip()+"\n")
          print("Generated daily_final.txt:")
          print(open("daily_final.txt","r",encoding="utf-8").read())
          PY

      - name: Archive daily report to repo
        run: |
          TODAY_BJ=$(TZ=Asia/Shanghai date +"%Y-%m-%d")
          mkdir -p archive
          cp daily_final.txt "archive/${TODAY_BJ}.txt"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add archive/*.txt
          git commit -m "chore: archive daily report ${TODAY_BJ}" || echo "No changes to commit"
          git push

      - name: Send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          python - <<'PY'
          import json, os
          text = open("daily_final.txt","r",encoding="utf-8").read()
          payload = {"msg_type":"text","content":{"text":text}}
          print(json.dumps(payload, ensure_ascii=False))
          PY
          curl -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$(python - <<'PY'
          import json
          text = open("daily_final.txt","r",encoding="utf-8").read()
          payload = {"msg_type":"text","content":{"text":text}}
          print(json.dumps(payload, ensure_ascii=False))
          PY
          )"
