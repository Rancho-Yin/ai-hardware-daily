name: AI Hardware Daily (Semi-auto) to Feishu

on:
  schedule:
    # 北京时间 07:30（UTC 23:30）
    - cron: "30 23 * * *"
  workflow_dispatch:

jobs:
  send-daily:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Build daily digest (RSS + keywords)
        run: |
          python scripts/rss_digest.py > daily.txt
          echo "Generated daily.txt:"
          cat daily.txt

      - name: Send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          python - <<'PY'
          import json, os
          text = open("daily.txt","r",encoding="utf-8").read()
          payload = {"msg_type":"text","content":{"text":text}}
          print(json.dumps(payload, ensure_ascii=False))
          PY
          curl -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$(python - <<'PY'
          import json
          text = open("daily.txt","r",encoding="utf-8").read()
          payload = {"msg_type":"text","content":{"text":text}}
          print(json.dumps(payload, ensure_ascii=False))
          PY
          )"
