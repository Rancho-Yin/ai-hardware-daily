name: AI Hardware Weekly Report to Feishu

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ å‘¨ä¸€ 08:35ï¼ˆUTC å‘¨ä¸€ 00:35ï¼‰
    - cron: "35 0 * * 1"
  workflow_dispatch:

jobs:
  send-weekly:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build weekly report from last 7 days
        run: |
          python - <<'PY'
          import os
          import glob
          from datetime import datetime, timedelta, timezone

          tz_bj = timezone(timedelta(hours=8))
          today = datetime.now(tz_bj).date()

          # å–æœ€è¿‘ 7 å¤©ï¼ˆä¸å«ä»Šå¤©ï¼‰ï¼šæ˜¨å¤© ~ å¾€å‰ 6 å¤©
          days = [(today - timedelta(days=i)).strftime("%Y-%m-%d") for i in range(1, 8)]

          files = []
          for d in reversed(days):  # ä»æ—§åˆ°æ–°
            p = f"archive/{d}.txt"
            if os.path.exists(p):
              files.append((d, p))

          def extract_titles(lines, section_name):
            # section_name: "ğŸŒ å…¨çƒ" or "ğŸ‡¨ğŸ‡³ ä¸­å›½"
            titles = []
            in_section = False
            for line in lines:
              if line.strip() == section_name:
                in_section = True
                continue
              if in_section and line.strip() in ["ğŸŒ å…¨çƒ", "ğŸ‡¨ğŸ‡³ ä¸­å›½"]:
                in_section = False
              if in_section:
                s = line.strip()
                if s[:2].isdigit() or s[:1].isdigit():
                  # æ ‡é¢˜è¡Œå½¢å¦‚ "1. xxx"
                  if ". " in s:
                    titles.append(s.split(". ", 1)[1])
            return titles

          def tag_of(title):
            # ä½ çš„ daily_final é‡Œå¦‚æœæœ‰ã€xxxã€‘å‰ç¼€ï¼Œè¿™é‡Œå°±èƒ½ç»Ÿè®¡
            if title.startswith("ã€") and "ã€‘" in title:
              return title.split("ã€‘", 1)[0] + "ã€‘"
            return "ã€æœªåˆ†ç±»ã€‘"

          all_global, all_china = [], []
          tag_count = {}

          for d, p in files:
            lines = open(p, "r", encoding="utf-8").read().splitlines()
            g = extract_titles(lines, "ğŸŒ å…¨çƒ")
            c = extract_titles(lines, "ğŸ‡¨ğŸ‡³ ä¸­å›½")
            all_global.extend(g)
            all_china.extend(c)
            for t in g + c:
              tg = tag_of(t)
              tag_count[tg] = tag_count.get(tg, 0) + 1

          def top_unique(items, k=10):
            seen = set()
            out = []
            for x in items:
              key = x.lower()
              if key in seen:
                continue
              seen.add(key)
              out.append(x)
              if len(out) >= k:
                break
            return out

          # ç®€å•å»é‡åå–å‰10æ¡ï¼ˆæŒ‰å‡ºç°é¡ºåºï¼‰
          g_top = top_unique(all_global, 10)
          c_top = top_unique(all_china, 10)

          # æ ‡ç­¾Top5
          tag_top = sorted(tag_count.items(), key=lambda x: x[1], reverse=True)[:5]

          start = (today - timedelta(days=7)).strftime("%Y-%m-%d")
          end = (today - timedelta(days=1)).strftime("%Y-%m-%d")
          week_title = f"ğŸ—ï¸ AIç¡¬ä»¶å‘¨æŠ¥ï½œ{start} ~ {end}"

          out = []
          out.append(week_title)
          out.append("")
          out.append(f"ã€æœ¬å‘¨è¦†ç›–ã€‘å·²å½’æ¡£ {len(files)} å¤©æ—¥æŠ¥ï¼ˆç›®æ ‡ 7 å¤©ï¼‰")
          out.append("")
          if tag_top:
            out.append("ã€çƒ­è¯æ ‡ç­¾ Topã€‘")
            for i, (t, n) in enumerate(tag_top, 1):
              out.append(f"{i}. {t} Ã— {n}")
            out.append("")

          out.append("ğŸŒ æœ¬å‘¨å…¨çƒè¦é—»ï¼ˆå»é‡ç²¾é€‰ï¼‰")
          if g_top:
            for i, t in enumerate(g_top, 1):
              out.append(f"{i}. {t}")
          else:
            out.append("ï¼ˆæœ¬å‘¨æœªæ±‡æ€»åˆ°å…¨çƒå†…å®¹ï¼Œæ£€æŸ¥ archive æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼‰")
          out.append("")

          out.append("ğŸ‡¨ğŸ‡³ æœ¬å‘¨ä¸­å›½è¦é—»ï¼ˆå»é‡ç²¾é€‰ï¼‰")
          if c_top:
            for i, t in enumerate(c_top, 1):
              out.append(f"{i}. {t}")
          else:
            out.append("ï¼ˆæœ¬å‘¨æœªæ±‡æ€»åˆ°ä¸­å›½å†…å®¹ï¼Œæ£€æŸ¥ archive æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼‰")
          out.append("")
          out.append("ğŸ“Œ è¯´æ˜ï¼šæœ¬å‘¨æŠ¥åŸºäºâ€œæ¯æ—¥RSS+å…³é”®è¯ç­›é€‰â€è‡ªåŠ¨æ±‡æ€»ï¼ˆåŠè‡ªåŠ¨ï¼‰ã€‚")

          open("weekly.txt", "w", encoding="utf-8").write("\n".join(out) + "\n")
          print(open("weekly.txt","r",encoding="utf-8").read())
          PY

      - name: Send weekly report to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          python - <<'PY'
          import json
          text = open("weekly.txt","r",encoding="utf-8").read()
          payload = {"msg_type":"text","content":{"text":text}}
          print(json.dumps(payload, ensure_ascii=False))
          PY
          curl -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$(python - <<'PY'
          import json
          text = open("weekly.txt","r",encoding="utf-8").read()
          payload = {"msg_type":"text","content":{"text":text}}
          print(json.dumps(payload, ensure_ascii=False))
          PY
          )"

